import{r as N,u as L,au as C,c as w,j as e,a6 as A,cV as M,h as l,P as R,a7 as I,a8 as D,a9 as Q,aa as S,ab as o,I as T,C as u,d as x,e as m,d3 as $,g as h,t as V,am as J,f as U,X as z,Y as X,Z as q,_ as n,$ as Y,a0 as i,T as Z,a1 as _,cg as E,c6 as F}from"./index-DHAHNq0D.js";function W(){const[k,v]=N.useState(!1),[d,p]=N.useState(null),{toast:r}=L(),{data:c=[],isLoading:P}=C({queryKey:["/api/inventory/audits"],queryFn:async()=>{const t=await fetch("/api/inventory/audits",{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch audits");return t.json()},staleTime:3e4}),{data:f=[]}=C({queryKey:["/api/inventory"],queryFn:async()=>{const t=await fetch("/api/inventory",{credentials:"include"});return t.ok?t.json():[]},staleTime:6e4}),y=w({mutationFn:async t=>await E("/api/inventory/audit",{method:"POST",body:JSON.stringify(t)}),onSuccess:()=>{F.invalidateQueries({queryKey:["/api/inventory/audits"]}),v(!1),r({title:"Audit Created",description:"Inventory audit has been created successfully"})},onError:t=>{r({title:"Error",description:t.message||"Failed to create audit",variant:"destructive"})}}),j=w({mutationFn:async({id:t,actualQuantity:s,notes:a})=>await E(`/api/inventory/audits/${t}/complete`,{method:"PATCH",body:JSON.stringify({actualQuantity:s,notes:a})}),onSuccess:()=>{F.invalidateQueries({queryKey:["/api/inventory/audits"]}),p(null),r({title:"Audit Completed",description:"Audit has been completed and variance calculated"})},onError:t=>{r({title:"Error",description:t.message||"Failed to complete audit",variant:"destructive"})}}),O=t=>{t.preventDefault();const s=new FormData(t.currentTarget),a=parseInt(s.get("inventoryItemId")),g=parseInt(s.get("expectedQuantity"));y.mutate({inventoryItemId:a,expectedQuantity:g,status:"pending"})},H=t=>{t.preventDefault();const s=new FormData(t.currentTarget),a=parseInt(s.get("actualQuantity")),g=s.get("notes");j.mutate({id:d.id,actualQuantity:a,notes:g})},B=t=>{const s={pending:{color:"bg-yellow-100 text-yellow-800",icon:"⏳"},completed:{color:"bg-green-100 text-green-800",icon:"✅"},discrepancy:{color:"bg-red-100 text-red-800",icon:"⚠️"}},a=s[t]||s.pending;return e.jsxs(_,{className:a.color,children:[a.icon," ",t.charAt(0).toUpperCase()+t.slice(1)]})},K=c.filter(t=>t.status==="pending"),b=c.filter(t=>t.status!=="pending");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Inventory Audits"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage inventory stock counts and audit trails"})]}),e.jsxs(A,{open:k,onOpenChange:v,children:[e.jsx(M,{asChild:!0,children:e.jsxs(l,{className:"flex items-center gap-2","data-testid":"button-create-audit",children:[e.jsx(R,{className:"h-4 w-4"}),"Start New Audit"]})}),e.jsxs(I,{"data-testid":"dialog-create-audit",children:[e.jsxs(D,{children:[e.jsx(Q,{children:"Start New Inventory Audit"}),e.jsx(S,{children:"Select an item and enter the expected quantity to start an audit"})]}),e.jsxs("form",{onSubmit:O,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(o,{htmlFor:"inventoryItemId",children:"Inventory Item"}),e.jsxs("select",{id:"inventoryItemId",name:"inventoryItemId",className:"w-full mt-1 p-2 border rounded-md",required:!0,"data-testid":"select-inventory-item",children:[e.jsx("option",{value:"",children:"Select an item..."}),f.map(t=>e.jsxs("option",{value:t.id,children:[t.medicationName," (",t.currentStock," units)"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"expectedQuantity",children:"Expected Quantity"}),e.jsx(T,{id:"expectedQuantity",name:"expectedQuantity",type:"number",placeholder:"Enter expected quantity",required:!0,min:"0","data-testid":"input-expected-quantity"})]}),e.jsx(l,{type:"submit",className:"w-full",disabled:y.isPending,"data-testid":"button-submit-audit",children:y.isPending?"Creating...":"Create Audit"})]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(u,{children:[e.jsxs(x,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(m,{className:"text-sm font-medium",children:"Pending Audits"}),e.jsx($,{className:"h-4 w-4 text-yellow-600"})]}),e.jsxs(h,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-pending-count",children:K.length}),e.jsx("p",{className:"text-xs text-gray-500",children:"Need to be completed"})]})]}),e.jsxs(u,{children:[e.jsxs(x,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(m,{className:"text-sm font-medium",children:"Completed"}),e.jsx(V,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(h,{children:[e.jsx("div",{className:"text-2xl font-bold","data-testid":"text-completed-count",children:b.length}),e.jsx("p",{className:"text-xs text-gray-500",children:"Audits finished"})]})]}),e.jsxs(u,{children:[e.jsxs(x,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(m,{className:"text-sm font-medium",children:"Discrepancies"}),e.jsx(J,{className:"h-4 w-4 text-red-600"})]}),e.jsxs(h,{children:[e.jsx("div",{className:"text-2xl font-bold text-red-600","data-testid":"text-discrepancy-count",children:b.filter(t=>t.status==="discrepancy").length}),e.jsx("p",{className:"text-xs text-gray-500",children:"Require attention"})]})]})]}),e.jsxs(u,{children:[e.jsxs(x,{children:[e.jsx(m,{children:"Audit History"}),e.jsx(U,{children:"View and manage all inventory audits"})]}),e.jsx(h,{children:P?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading audits..."}):c.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:'No audits found. Click "Start New Audit" to begin.'}):e.jsxs(z,{"data-testid":"table-audits",children:[e.jsx(X,{children:e.jsxs(q,{children:[e.jsx(n,{children:"Audit Date"}),e.jsx(n,{children:"Item"}),e.jsx(n,{children:"Expected"}),e.jsx(n,{children:"Actual"}),e.jsx(n,{children:"Variance"}),e.jsx(n,{children:"Status"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(Y,{children:c.map(t=>{const s=f.find(a=>a.id===t.inventoryItemId);return e.jsxs(q,{"data-testid":`audit-row-${t.id}`,children:[e.jsx(i,{children:new Date(t.auditDate).toLocaleDateString()}),e.jsx(i,{children:(s==null?void 0:s.medicationName)||"Unknown"}),e.jsx(i,{children:t.expectedQuantity||"-"}),e.jsx(i,{children:t.actualQuantity||"-"}),e.jsx(i,{children:t.variance!==null&&t.variance!==void 0?e.jsxs("span",{className:t.variance<0?"text-red-600 font-semibold":t.variance>0?"text-green-600 font-semibold":"",children:[t.variance>0?"+":"",t.variance]}):"-"}),e.jsx(i,{children:B(t.status)}),e.jsx(i,{children:t.status==="pending"&&e.jsx(l,{size:"sm",variant:"outline",onClick:()=>p(t),"data-testid":`button-complete-${t.id}`,children:"Complete"})})]},t.id)})})]})})]}),e.jsx(A,{open:!!d,onOpenChange:t=>!t&&p(null),children:e.jsxs(I,{"data-testid":"dialog-complete-audit",children:[e.jsxs(D,{children:[e.jsx(Q,{children:"Complete Audit"}),e.jsx(S,{children:"Enter the actual counted quantity for this item"})]}),e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 p-3 rounded-md",children:[e.jsx("div",{className:"text-sm font-medium",children:"Expected Quantity:"}),e.jsx("div",{className:"text-2xl font-bold",children:d==null?void 0:d.expectedQuantity})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"actualQuantity",children:"Actual Counted Quantity"}),e.jsx(T,{id:"actualQuantity",name:"actualQuantity",type:"number",placeholder:"Enter actual quantity",required:!0,min:"0","data-testid":"input-actual-quantity"})]}),e.jsxs("div",{children:[e.jsx(o,{htmlFor:"notes",children:"Notes (Optional)"}),e.jsx(Z,{id:"notes",name:"notes",placeholder:"Add any notes about this audit...",rows:3,"data-testid":"textarea-audit-notes"})]}),e.jsx(l,{type:"submit",className:"w-full",disabled:j.isPending,"data-testid":"button-submit-complete",children:j.isPending?"Completing...":"Complete Audit"})]})]})})]})}export{W as default};
